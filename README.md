# CoinMetric

Android-приложение для семейного планирования бюджета с локальной БД и базовой синхронизацией через Google-аккаунт.

## Что уже сделано

### Базовые функции
- Реализована локальная база данных на Room:
  - категории,
  - участники семьи,
  - транзакции,
  - лимиты по категориям,
  - постоянные платежи.
- Добавлен семейный сценарий использования: хранение и отображение участников с email.
- Реализованы категории расходов и месячные лимиты с отображением прогресса в дашборде.
- Добавлены постоянные платежи.
- Добавлено создание транзакций с мини-калькулятором выражений (например, `1200+350/2`).
- В дашборд добавлены регулярные отчёты за неделю и месяц: доходы, расходы, топ-категория и динамика к прошлому периоду.

### Просмотр и аналитика
- Реализован календарный просмотр операций по дням.
- Реализован аналитический дэшборд:
  - доходы,
  - расходы,
  - баланс,
  - расходы по категориям.

### Инфраструктура
- Подключён WorkManager-воркер для периодической синхронизации.
- Реализована система синхронизации с Firebase для хранения данных в облаке.


### Что реализовано по синхронизации
- Модель Firestore теперь включает:
  - коллекции доменных сущностей (`categories`, `members`, `transactions`, `recurring`, `invites`, `limits`),
  - коллекцию `changes` для change log с типом сущности, id, действием и timestamp.
- Локально добавлены таблицы:
  - `SyncChangeLog` — журнал локальных/удалённых изменений,
  - `SyncState` — курсоры `lastPulledAtEpochMillis` и `lastPushedAtEpochMillis`.
- WorkManager-воркер выполняет двусторонний инкрементальный sync:
  1. pull только изменённых записей с Firestore с момента последнего pull,
  2. merge в локальную БД с conflict resolution (last write wins),
  3. push только локальных изменений с момента последнего push,
  4. обновление курсоров синхронизации.

## Технологический стек
- Kotlin + Jetpack Compose
- Room
- WorkManager
- Firebase

## План следующих действий

### 1) Синхронизация данных
- [x] Спроектировать серверную/облачную модель (Firestore) с коллекциями сущностей и журналом изменений.
- [x] Реализовать двустороннюю синхронизацию с разрешением конфликтов по `updatedAtEpochMillis` (LWW).
- [x] Добавить журнал изменений (change log) и инкрементальные обновления через курсоры pull/push.

### 2) Совместная работа семьи
- [x] Добавить базовые приглашения участников в семейный бюджет по email (валидация, выбор роли, список приглашений в UI).
- [x] Расширить жизненный цикл приглашений в UI: отправка, принятие и отклонение с обновлением статуса.
- [x] Разграничить роли (владелец, редактор, просмотр).
- [x] Логировать действия участников (кто и что изменил).

### 3) Контроль бюджета
- [x] Реализовать полноценные лимиты по категориям на месяц.
- [x] Добавить push/локальные уведомления о приближении и превышении лимитов.
- [x] Добавить регулярные отчёты (неделя/месяц) по расходам.

### 4) UX и стабильность
- [x] Улучшить пустые состояния для ключевых экранов (дашборд, транзакции, календарь, семья, платежи).
- [x] Добавить onboarding и подсказки для первого запуска.
- [x] Добавить офлайн-first обработку ошибок синхронизации.
- [x] Покрыть ключевые сценарии тестами (unit + UI) и настроить CI-проверки.

### 5) Улучшение дизайна (UI refresh)
- [x] Составить план визуального обновления экранов (иерархия, отступы, карточки, единая типографика).
- [x] Внедрить базовый слой нового UI: AppBar, единые секции-карточки, улучшенные блоки сводки и отчётов.
- [x] Привести формы ввода к единому стилю (ширина полей, группировка действий, читаемые состояния пустых списков).
- [x] Добавить адаптивные размеры/брейкпоинты для планшетов и landscape-режима.
- [x] Добавить дизайн-токены (цвета/скругления/типографика) через выделенную тему Compose.

### 6) Синхронизация с Firebase
- [x] Настроить подключение к Firebase для хранения данных в облаке.
- [x] Реализовать двустороннюю синхронизацию между локальной и облачной базами.
- [x] Обеспечить конфликт-резолюцию при синхронизации изменений.

## Реализация плана по дизайну (что уже внедрено)

- Экран получил новый визуальный каркас: верхний `TopAppBar` + вкладки для стабильной навигации.
- Введён единый компонент `SectionCard` для консистентного отображения блоков на всех вкладках.
- Улучшено представление сводки бюджета, лимитов, отчётов и аналитики через переиспользуемые строки `SummaryRow`.
- Формы на вкладках «Транзакции», «Семья» и «Платежи» унифицированы: поля ввода на всю ширину, действия логически сгруппированы.
- Пустые состояния визуально выровнены через карточку с `surfaceVariant`, чтобы акцентировать подсказки и onboarding-поток без перегруза интерфейса.

- Добавлен onboarding-блок «Быстрый старт» на главном экране с ключевыми шагами первого запуска и действием скрытия подсказок.
- В настройки добавлен переключатель показа onboarding-подсказок, чтобы пользователь мог заново включить их при необходимости.

- Добавлены адаптивные брейкпоинты контейнера контента (`AdaptiveScreenContainer`): контент центрируется и ограничивается по ширине на больших экранах, вкладки переведены в `ScrollableTabRow` для стабильной работы в portrait/landscape.
- Введена выделенная тема `CoinMetricTheme` с дизайн-токенами (цвета и скругления) и подключена в `MainActivity` как единая точка стилизации приложения.
- Добавлена офлайн-first обработка ошибок синхронизации в настройках: отображаются статус синхронизации, очередь локальных изменений и кнопка повторной отправки после восстановления сети.
- В настройках реализован рабочий сценарий приглашения участника: ввод email, выбор роли (просмотр/редактор), валидация и список отправленных приглашений.
- Добавлен жизненный цикл приглашений в разделе «Семейный доступ»: статус можно перевести из «Ожидает принятия» в «Принято» или «Отклонено», а изменения отражаются в списке и очереди синхронизации.


## Проверка соответствия README и текущей реализации

- Актуализирована логика совместной работы: для приглашений добавлена строгая валидация статусов и нормализация email при изменении статуса/отзыве.
- Уточнена стабильность синхронизации: повторная отправка (`retry sync`) теперь возвращает явные ошибки, если отключён Google Sync или включён офлайн-режим.
- Улучшен аудит действий: добавлено логирование изменения темы и переключения Google Sync, а также защита от дублей логов при отсутствии фактических изменений.
- Расширено покрытие unit-тестами по приглашениям, синхронизации и системным настройкам.

### Текущая итерация (выполнено 30 задач)
1. Введён whitelist допустимых статусов приглашения.
2. Добавлена валидация статуса перед обновлением.
3. Запрещён возврат статуса в `Ожидает принятия`.
4. Нормализован email при обновлении статуса приглашения.
5. Поиск приглашений для обновления статуса стал регистронезависимым.
6. Обновление статуса выставляет success-message.
7. Нормализован email при отзыве приглашения.
8. Отзыв приглашения выполняется регистронезависимо.
9. Сообщение об отзыве унифицировано.
10. Activity log по отзыву пишет нормализованный email.
11. Изменение invite email очищает предыдущий feedback.
12. Изменение invite role очищает предыдущий feedback.
13. Добавлено логирование смены темы.
14. Исключены дубли логов при повторной установке той же темы.
15. Добавлено логирование Google Sync.
16. При отключении Google Sync устанавливается явная причина в syncError.
17. После успешной синхронизации syncError очищается.
18. Повторная установка текущего плана подписки игнорируется.
19. Повторная установка текущей роли игнорируется.
20. При успешной смене роли очищается inviteError.
21. `retrySync` сообщает о выключенном Google Sync.
22. `retrySync` сообщает о включённом офлайн-режиме.
23. Добавлен unit-тест для case-insensitive обновления статуса.
24. Добавлен unit-тест невалидного статуса.
25. Добавлен unit-тест запрета статуса `Ожидает принятия`.
26. Добавлен unit-тест нормализации email при отзыве.
27. Добавлен unit-тест очистки feedback при изменении email.
28. Добавлен unit-тест очистки feedback при смене роли приглашения.
29. Добавлены unit-тесты логирования темы и недопущения дублей.
30. Добавлены unit-тесты для новых веток `setGoogleSync` и `retrySync`.


### Текущая итерация (дополнительно выполнено 20 задач)
1. Добавлена строгая email-валидация приглашений через regex.
2. Невалидный email теперь блокирует отправку приглашения без создания записи.
3. `updateInviteRole` нормализует роль приглашения (`trim + lowercase`).
4. Для невалидной роли приглашения выставляется явная ошибка.
5. `setCurrentUserRole` нормализует входящую роль пользователя.
6. `setSubscriptionPlan` нормализует входящий тариф (`trim + lowercase`).
7. `setRecurringReminders` игнорирует повторную установку того же значения.
8. `setOfflineMode` игнорирует повторную установку того же значения.
9. `setPinProtectionEnabled` игнорирует повторную установку того же значения.
10. `setBiometricProtectionEnabled` игнорирует повторную установку того же значения.
11. `completeSecuritySetup` не пишет повторный лог после завершённого мастера.
12. `dismissOnboarding` добавляет запись в activity log о скрытии подсказок.
13. `setOnboardingVisible` логирует включение/отключение onboarding-подсказок.
14. `setOnboardingVisible` не создаёт дубли логов при неизменном значении.
15. Для роли `viewer` запрещено обновление статуса приглашений.
16. Для запрета `viewer` на смену статуса приглашений добавлен отдельный `inviteError`.
17. Добавлено логирование отказа в отправке приглашения (не-владелец).
18. Добавлено логирование отказа в отзыве приглашения (не-владелец).
19. Добавлено логирование отказа в смене статуса приглашения (роль `viewer`).
20. Расширены unit-тесты для всех новых веток валидации, нормализации, anti-duplicate и audit log.
