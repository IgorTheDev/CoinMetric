# План по созданию Android-приложения CoinMetric

## 1. Общая структура приложения

### 1.1. Архитектура
- Использовать MVVM (Model-View-ViewModel) паттерн
- Использовать Navigation Component для навигации между фрагментами

## 2. Дизайн интерфейса

### 2.1. Цветовая схема
- Основной цвет: #3B82F6 (синий для акцентов)
- Цвет фона: #111827 (темный режим) или #FFFFFF (светлый режим)
- Вторичные цвета:
  - Зеленый: #10B981 (доходы)
  - Красный: #EF4444 (расходы)
  - Фиолетовый: #A855F7
  - Желтый: #EAB308
  - Оранжевый: #F97316

### 2.2. Типографика
- Основной шрифт: Inter (для текста) и Outfit (для заголовков)
- Размеры шрифтов:
  - Заголовки: 24sp, 20sp, 18sp
  - Основной текст: 16sp, 14sp
  - Подписи: 12sp, 10sp

### 2.3. Компоненты интерфейса

#### 2.3.1. Навигационное меню (Bottom Navigation)
- 5 пунктов меню:
  - Главная (иконка дома)
  - Календарь (иконка календаря)
  - Добавить (иконка плюса в круге)
  - Аналитика (иконка графика)
  - Настройки (иконка шестеренки)
- Центральная кнопка "Добавить" выделена и поднята над основным уровнем
- Анимации при выборе элементов

#### 2.3.2. Карточки (Cards)
- Закругленные углы (24dp)
- Тени (shadow)
- Анимации при нажатии (scale)
- Различные размеры в зависимости от контента

#### 2.3.3. Элементы форм
- Поля ввода с закругленными углами
- Выпадающие списки (Spinner/Custom dropdown)
- Переключатели (Switch)
- Кнопки с анимациями (ripple effect)

### 2.4. Анимации
- Плавные переходы между экранами
- Анимации при загрузке данных
- Hover-эффекты (когда применимо)
- Анимации прогресс-баров и диаграмм

## 3. Экраны приложения

### 3.1. Главная страница (Dashboard)
- Отображение общего баланса
- Карточка с общей информацией (доходы/расходы)
- Блок с быстрой статистикой (лимит, расходы в день)
- График тренда расходов (Area Chart)
- Последние транзакции (список с аватарами и категориями)

### 3.2. Экран добавления транзакции
- Поле ввода суммы (калькуляторный ввод)
- Выбор категории из списка
- Поле заметки
- Переключатель "Постоянный платеж"
- Кнопка "Сохранить"

### 3.3. Экран аналитики
- Круговая диаграмма по категориям расходов
- Информация о лимитах по категориям
- Прогресс-бары заполнения лимитов
- Цветовое кодирование превышений

### 3.4. Экран календаря
- Календарь с выделением дней с транзакциями
- Список транзакций по выбранному дню
- Анимации при смене даты

### 3.5. Экран настроек
- Переключатель темы (светлая/темная)
- Блок синхронизации (Google Sync)
- Управление членами семьи
- Настройки подписки
- Настройки безопасности
- Кнопка выхода

## 6. Реализация функциональности

### 6.1. Темная/светлая тема
- Использовать AppCompatDelegate для переключения тем
- Определить стили для обеих тем

### 6.2. Диаграммы
- Использовать MPAndroidChart для отображения графиков
- Реализовать Area Chart для тренда расходов
- Реализовать Pie Chart для аналитики по категориям

### 6.3. Анимации
- Использовать View Animation или Property Animation
- Для сложных анимаций использовать Lottie или собственные анимации

### 6.4. Асинхронные операции
- Использовать Kotlin Coroutines
- Использовать ViewModel и LiveData для обновления UI

## 7. Дополнительные компоненты

### 7.1. Кастомные виджеты
- Калькуляторный ввод для суммы
- Кастомные карточки с эффектами
- Кастомный календарь

### 7.2. Уведомления
- Уведомления о превышении лимита
- Напоминания о постоянных платежах

### 7.3. Синхронизация
- Интеграция с Google Drive или Firebase
- Синхронизация данных между устройств

## 8. Проверка соответствия и старт разработки

### 8.1. Текущее соответствие
- [x] Используется MVVM и ViewModel для управления состоянием
- [x] Навигация между ключевыми экранами уже реализована
- [x] Базовые экраны (Dashboard, Calendar, Add, Analytics, Settings) уже присутствуют
- [x] Переключение темы доступно в настройках
- [x] Для асинхронных операций используется Kotlin Coroutines
- [x] Подготовлена синхронизация через Firebase

### 8.2. Что уже реализовано по приоритетам
- [x] Приведение темы к целевой палитре и типографике (цвета/размеры)
- [x] Улучшение Bottom Navigation: центральная приподнятая кнопка "Добавить"
- [x] Доработка карточек с единым скруглением 24dp и улучшенными состояниями нажатия
- [x] Подготовка аналитических диаграмм (интеграция MPAndroidChart)

### 8.3. Актуальные следующие шаги
1. [x] Разграничить роли (владелец, редактор, просмотр) для управления семейным доступом и операций.
2. [x] Добавить логирование действий участников (кто и что изменил).
3. [x] Расширить покрытие тестами (unit + UI) и подготовить CI-проверки.

### 8.4. Обновление по текущей итерации
- [x] Добавлен журнал действий участников в настройках: фиксируется актор, действие, объект изменения и время.
- [x] Логируются ключевые события совместной работы: отправка приглашения, смена статуса приглашения, создание/редактирование операции, переключение роли.
- [x] Усилены проверки прав доступа по ролям (владелец/editor/viewer) для приглашений и операций.
- [x] Расширены unit-тесты: сценарии категорий, лимитов, ролей и логирования.
- [x] Добавлен базовый UI-тест на видимость ключевых пунктов нижней навигации.
- [x] Подготовлен CI workflow (lint + unit + instrumentation) с JDK 17 для стабильной сборки.

### 8.5. Корректировка соответствия (текущая доработка)
- [x] На экране добавления операции включен переключатель "Постоянный платёж".
- [x] В настройках добавлено управляемое переключение напоминаний о платежах вместо статичного текста.
- [x] Логирование дополнено событиями по постоянным платежам и включению/отключению напоминаний.
- [x] Unit-тесты расширены сценариями для постоянных платежей и настройки напоминаний.

### 8.6. Следующие шаги по plan.md
1. [x] Привязать напоминания о постоянных платежах к WorkManager/AlarmManager и фактическим уведомлениям по расписанию.
2. [x] Добавить экран/раздел подписки и безопасности (PIN/биометрия), заявленные в разделе настроек.
3. [x] Расширить UI-тесты для сценариев ролей и редактирования операций.

### 8.7. Обновление по текущей итерации (продолжение)
- [x] Реализован `RecurringPaymentReminderWorker` + `RecurringReminderScheduler` на WorkManager с ежедневным запуском и реальным push-уведомлением.
- [x] Включение/выключение напоминаний в настройках теперь управляет постановкой/снятием периодической задачи WorkManager.
- [x] В настройки добавлен блок «Подписка и безопасность»: переключение тарифа (Free/Pro), PIN-защита и биометрия.
- [x] Добавлены unit-тесты для подписки и сценариев PIN/биометрии.
- [x] UI-тест расширен сценарием роли «Просмотр»: проверка ограничения на добавление операций.
- [x] Добавить отдельный UI-тест на сценарий редактирования операции.

- [x] Добавлен UI-тест сценария редактирования: выбор операции в календаре переводит форму в режим «Сохранить изменения».

### 8.8. Обновление по текущей итерации (дополнение)
- [x] Усилены ограничения роли «Просмотр»: удаление операций теперь заблокировано на уровне ViewModel.
- [x] На календарном экране кнопка удаления отключается для роли «Просмотр» и показывается поясняющее сообщение.
- [x] Добавлена анимация смены даты/месяца в календаре для более плавного UX.
- [x] Улучшен блок аналитики лимитов: добавлено состояние пустого списка и явная индикация превышения лимита.
- [x] Расширено журналирование: фиксируются создание категории, обновление лимита и удаление операции.
- [x] Расширены тесты: unit-сценарии для новых ограничений/логов и UI-проверка ограничения удаления для роли «Просмотр».

### 8.9. Следующие шаги по plan.md
1. [x] Добавить локальные уведомления о скором превышении лимита (порог 80%) с глубоким переходом в аналитику.
2. [x] Вынести экран управления подпиской в отдельный маршрут с деталями преимуществ тарифов.
3. [x] Добавить мастер первичной настройки безопасности (PIN + биометрия) при первом запуске.


### 8.10. Обновление по текущей итерации (дальнейшее продвижение)
- [x] Добавлен event-поток `limitAlertEvent` во ViewModel для детерминированной доставки лимитных предупреждений в UI.
- [x] Реализован deep-link сценарий открытия аналитики из локальных уведомлений (через `MainActivity.EXTRA_START_ROUTE`).
- [x] Настройки переведены на отдельный маршрут подписки/безопасности с карточкой перехода и описанием преимуществ Free/Pro.
- [x] Добавлен мастер первичной настройки безопасности в настройках с завершением после включения PIN.
- [x] Расширены тесты: unit-сценарии для мастера и лимитных событий + UI-навигация в раздел подписки.


### 8.11. Обновление по текущей итерации (контроль прав и стабильности, 15 задач)
1. [x] Добавлена валидация допустимых ролей пользователя (`owner/editor/viewer`) при переключении роли.
2. [x] Добавлена защита от некорректных планов подписки (разрешены только `free/pro`).
3. [x] Нормализован email приглашения (trim + lowercase) перед сохранением.
4. [x] Добавлена проверка корректности роли приглашения (только `editor/viewer`).
5. [x] Добавлена блокировка дублей активных приглашений для одного email.
6. [x] Добавлен метод очистки сообщений об ошибке/успехе приглашений.
7. [x] Реализован отзыв приглашения владельцем для статуса «Ожидает принятия».
8. [x] Добавлена защита: роль «Просмотр» не может создавать категории.
9. [x] Добавлена защита: роль «Просмотр» не может изменять лимиты категорий.
10. [x] Улучшена безопасность: при отключении/включении PIN сбрасывается ошибка `syncError`.
11. [x] Усилена логика мастера безопасности: завершение доступно только после включения PIN.
12. [x] Добавлено логирование включения/выключения автономного режима в журнал действий.
13. [x] Расширены unit-тесты: проверка ошибки завершения мастера без PIN.
14. [x] Расширены unit-тесты: проверка дубликатов и отзыва приглашений.
15. [x] Расширены unit-тесты: проверки ограничений роли viewer (категории/лимиты), валидации ролей/тарифов и очистки invite feedback.


### 8.12. Обновление по текущей итерации (минимум 30 задач)
1. [x] Добавлен справочник допустимых статусов приглашения (`Ожидает принятия`, `Принято`, `Отклонено`).
2. [x] Добавлена валидация статуса приглашения перед обновлением.
3. [x] Запрещён перевод приглашения обратно в статус `Ожидает принятия`.
4. [x] Нормализован email при обновлении статуса приглашения (trim + lowercase).
5. [x] Поиск приглашения при обновлении статуса сделан case-insensitive.
6. [x] Обновление статуса теперь выставляет `inviteSuccessMessage`.
7. [x] Нормализован email при отзыве приглашения.
8. [x] Поиск и удаление приглашения при отзыве сделаны case-insensitive.
9. [x] Сообщение об успешном отзыве теперь использует нормализованный email.
10. [x] Таргет в activity log по отзыву приглашения унифицирован до нормализованного email.
11. [x] При редактировании email приглашения очищаются и ошибка, и success-message.
12. [x] При смене роли приглашения очищаются и ошибка, и success-message.
13. [x] Добавлено логирование смены темы приложения (светлая/тёмная).
14. [x] Добавлена защита от повторного логирования темы при неизменном значении.
15. [x] Добавлено логирование включения/выключения Google Sync.
16. [x] При отключении Google Sync выставляется понятная причина в `syncError`.
17. [x] При успешной синхронизации очищается `syncError`.
18. [x] Добавлен early-return в `setSubscriptionPlan`, если план не изменился.
19. [x] Добавлен early-return в `setCurrentUserRole`, если роль не изменилась.
20. [x] При успешной смене роли дополнительно очищается `inviteError`.
21. [x] Добавлена проверка `retrySync`: ошибка, если Google Sync выключен.
22. [x] Добавлена проверка `retrySync`: ошибка, если включён офлайн-режим.
23. [x] Добавлен unit-тест обновления статуса приглашения с email в другом регистре.
24. [x] Добавлен unit-тест ошибки при невалидном статусе приглашения.
25. [x] Добавлен unit-тест ошибки при попытке вернуть статус `Ожидает принятия`.
26. [x] Добавлен unit-тест нормализации email при отзыве приглашения.
27. [x] Добавлен unit-тест очистки invite feedback при изменении email.
28. [x] Добавлен unit-тест очистки invite feedback при смене роли приглашения.
29. [x] Добавлен unit-тест логирования темы и защита от дублей логов.
30. [x] Добавлены unit-тесты для `retrySync` и `setGoogleSync` по новым сценариям ошибок.


### 8.13. Обновление по текущей итерации (дополнительно 20 задач)
1. [x] Добавлена regex-валидация email в `sendFamilyInvite`.
2. [x] Ошибка `Некорректный email` покрывает сценарий `user@` и похожие некорректные значения.
3. [x] Роль приглашения в `updateInviteRole` нормализуется (`trim + lowercase`).
4. [x] Для невалидной роли приглашения возвращается `inviteError`.
5. [x] Тариф в `setSubscriptionPlan` нормализуется перед валидацией.
6. [x] Роль в `setCurrentUserRole` нормализуется перед валидацией.
7. [x] Добавлен early-return в `setRecurringReminders`, если значение не меняется.
8. [x] Добавлен early-return в `setOfflineMode`, если значение не меняется.
9. [x] Добавлен early-return в `setPinProtectionEnabled`, если значение не меняется.
10. [x] Добавлен early-return в `setBiometricProtectionEnabled`, если значение не меняется.
11. [x] Добавлен early-return в `completeSecuritySetup`, если мастер уже завершён.
12. [x] `dismissOnboarding` теперь пишет событие в activity log.
13. [x] `setOnboardingVisible` теперь пишет событие в activity log.
14. [x] `setOnboardingVisible` защищён от дублей логов при повторной установке того же значения.
15. [x] Роль `viewer` не может менять статус приглашений.
16. [x] Для запрета смены статуса приглашений ролью `viewer` добавлена понятная ошибка.
17. [x] Логируется отказ в отправке приглашения при роли, отличной от owner.
18. [x] Логируется отказ в отзыве приглашения при роли, отличной от owner.
19. [x] Логируется отказ в изменении статуса приглашения при роли `viewer`.
20. [x] Unit-тесты расширены для новых сценариев валидации, нормализации и журналирования.
